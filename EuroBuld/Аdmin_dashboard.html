<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | –¢–∞–±–ª–∏—Ü—ã</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 200px;
      background-color: #e4d0d0;
      padding-top: 20px;
      color: #333;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      border-right: 1px solid #ccc;
    }

    .sidebar div {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .sidebar div:hover {
      font-weight: bold;
    }

    .main {
      flex-grow: 1;
      padding: 20px;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px;
    }

    .topbar .profile {
      background-color: #560019;
      color: white;
      padding: 8px 15px;
      border-radius: 50px;
    }

    .table-wrapper {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      flex-grow: 1;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background-color: transparent;
      font-weight: bold;
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .actions button {
      background-color: #560019;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div onclick="loadTable('users')"><span>üë§</span> –ö–ª–∏–µ–Ω—Ç—ã</div>
    <div onclick="loadTable('staff')"><span>üë•</span> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div>
    <div onclick="loadTable('services')"><span>üõ†</span> –£—Å–ª—É–≥–∏</div>
    <div><span>üîî</span> –ó–∞–∫–∞–∑—ã</div>
    <div><span>üìä</span> –û—Ç—á–µ—Ç—ã</div>
    <div><span>‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>

  <div class="main">
    <div class="topbar">
      <div class="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <div class="table-wrapper" id="tableContainer"></div>

    <div class="actions">
        <button onclick="openModal('add')">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="openModal('edit')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button onclick="deleteRecord()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>  
  </div>

<!-- –î–æ–±–∞–≤–ª—è–µ–º –≤ body –ø–µ—Ä–µ–¥ </body> -->

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
     background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:300px;">
    <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
    <form id="modalForm">
      <div id="formFields"></div>
      <input type="hidden" name="id" id="recordId">
      <div style="text-align:right; margin-top:10px;">
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentTable = 'users';
  let tableData = [];

  async function loadTable(type) {
    currentTable = type;
    let url = `/api/${type}`;
    const res = await fetch(url);
    const data = await res.json();
    tableData = data;

    if (!Array.isArray(data) || data.length === 0) {
      document.getElementById('tableContainer').innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
      return;
    }

    let html = '<table><thead><tr>';
    for (let key in data[0]) {
      html += `<th>${key}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (let row of data) {
      html += `<tr onclick="selectRow(this)">`;
      for (let key in row) {
        html += `<td>${row[key]}</td>`;
      }
      html += '</tr>';
    }

    html += '</tbody></table>';
    document.getElementById('tableContainer').innerHTML = html;
  }

  function selectRow(row) {
    document.querySelectorAll('tr').forEach(r => r.style.backgroundColor = '');
    row.style.backgroundColor = '#ffe0e0';
    row.setAttribute('data-selected', 'true');
  }

  function getSelectedRowData() {
    const selected = document.querySelector('tr[data-selected="true"]');
    if (!selected) return null;

    const values = [...selected.children].map(td => td.textContent);
    const keys = Object.keys(tableData[0]);

    return Object.fromEntries(keys.map((k, i) => [k, values[i]]));
  }

  function addRow() {
  openModal('add');
}

function editRow() {
  openModal('edit');
}

function deleteRow() {
  deleteRecord();
}


function openModal(mode) {
  console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ:', mode);
  const modal = document.getElementById('modal');
  const formFields = document.getElementById('formFields');
  const modalTitle = document.getElementById('modalTitle');
  formFields.innerHTML = '';

  let data = mode === 'edit' ? getSelectedRowData() : {};
  console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', data);
  if (mode === 'edit' && !data) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è.');

  modalTitle.textContent = mode === 'edit' ? '–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å' : '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';

  for (let key in tableData[0]) {
    if (key.toLowerCase().includes('id')) continue;
    formFields.innerHTML += `
      <div>
        <label>${key}</label>
        <input name="${key}" value="${data?.[key] || ''}" required />
      </div>
    `;
  }

  document.getElementById('recordId').value = data?.[Object.keys(data)[0]] || '';
  modal.style.display = 'flex';
}


  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  document.getElementById('modalForm').addEventListener('submit', async e => {
    e.preventDefault();

    const form = e.target;
    const data = {};
    for (let input of form.querySelectorAll('input[name]')) {
      data[input.name] = input.value;
    }

    const id = form.querySelector('#recordId').value;

    const method = id ? 'PUT' : 'POST';
    const url = `/api/${currentTable}${id ? '/' + id : ''}`;
    await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal();
    loadTable(currentTable);
  });

  async function deleteRecord() {
    const data = getSelectedRowData();
    if (!data) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');

    const id = Object.values(data)[0];
    const confirmed = confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å?');
    if (!confirmed) return;

    await fetch(`/api/${currentTable}/${id}`, { method: 'DELETE' });
    loadTable(currentTable);
  }

  loadTable('users');
</script>

</body>
</html>
