<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админ-панель | Таблицы</title>
  <link rel="stylesheet" href="css/styele.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background-color: #f9f9f9;
    }
    /* Добавляем стили для счетчика символов */
    .char-counter {
      font-size: 12px;
      color: #666;
      text-align: right;
      margin-top: 2px;
    }
    .char-counter.limit-reached {
      color: #e74c3c;
    }
    .modal-field {
      margin-bottom: 15px;
    }
    .modal-field label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .modal-field input, 
    .modal-field select, 
    .modal-field textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div onclick="loadTable('users')"><i class="fas fa-user"></i> Клиенты</div>
    <div onclick="loadTable('staff')"><i class="fas fa-users"></i> Сотрудники</div>
    <div onclick="loadTable('service')"><i class="fas fa-tools"></i> Услуги</div>
    <div onclick="loadTable('role')"><i class="fas fa-user-tag"></i> Роли</div>
    <div onclick="loadTable('customer_orders')"><i class="fas fa-box"></i> Заказы</div>
    <div onclick="loadTable('processed_customer_orders')"><i class="fas fa-check-circle"></i> Обработанные</div>
    <div onclick="loadTable('requests')"><i class="fas fa-envelope"></i> Заявки</div>
    <div onclick="loadTable('foremen')"><i class="fas fa-hard-hat"></i> Начальники</div>
    <div onclick="loadTable('status_orders')"><i class="fas fa-tasks"></i> Статусы</div>
    <a href="report.html"><div><i class="fas fa-chart-bar"></i> Отчёты</div></a>
    <div><i class="fas fa-cog"></i> Настройки</div>
  </div>  
  <div class="main">
    <div class="topbar">
      <a href="index.html"><div class="profile">Выйти</div></a>
    </div>
    <div class="table-wrapper" id="tableContainer"></div>
    <div class="actions">
      <button onclick="openModal('add')">Добавить</button>
      <button onclick="openModal('edit')">Изменить</button>
      <button onclick="deleteRecord()">Удалить</button>
    </div>
  </div>

  <div id="modal">
    <div id="modalContent">
      <h3 id="modalTitle">Добавить запись</h3>
      <form id="modalForm">
        <div id="formFields"></div>
        <input type="hidden" name="id" id="recordId">
        <div class="modal-actions">
          <button type="submit" class="save">Сохранить</button>
          <button type="button" class="cancel" onclick="closeModal()">Отмена</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentTable = 'users';
    let tableData = [];
    let rolesData = [];
    let statusesData = [];

    async function loadStatuses() {
      if (statusesData.length === 0) {
        const res = await fetch('/api/status_orders');
        statusesData = await res.json();
      }
      return statusesData;
    }
    async function loadRoles() {
      const res = await fetch('/api/role');
      rolesData = await res.json();
    }
    loadRoles();

    async function loadTable(type) {
      currentTable = type;
      let url = `/api/${type}`;
      const res = await fetch(url);
      const data = await res.json();
      tableData = data;

      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById('tableContainer').innerHTML = '<p>Нет данных</p>';
        return;
      }

      let html = '<table><thead><tr>';
      for (let key in data[0]) {
        html += `<th>${key}</th>`;
      }
      html += '</tr></thead><tbody>';

      for (let row of data) {
        html += '<tr onclick="selectRow(this)">';
        for (let key in row) {
          if (key === 'ImageBase64') {
            html += `<td><img src="data:image/jpeg;base64,${row[key]}" alt="Image" style="width:100px;height:auto;"/></td>`;
          } else {
            html += `<td>${row[key]}</td>`;
          }
        }
        html += '</tr>';
      }

      html += '</tbody></table>';
      document.getElementById('tableContainer').innerHTML = html;
    }

    const fieldConstraints = {
        'users': {
            'Email': { maxLength: 40, type: 'text' },
            'Password': { maxLength: 255, type: 'text' },
            'Number_Phone': { maxLength: 20, type: 'text' },
            'Address': { maxLength: 20, type: 'text' },
            'First_name': { maxLength: 20, type: 'text' },
            'Last_name': { maxLength: 20, type: 'text' },
            'Patronymic': { maxLength: 20, type: 'text' },
            'Passport_details': { maxLength: 20, type: 'text' }
        },
        'staff': {
            'Email': { maxLength: 40, type: 'text' },
            'Password': { maxLength: 255, type: 'text' },
            'First_name': { maxLength: 20, type: 'text' },
            'Last_name': { maxLength: 20, type: 'text' },
            'Patronymic': { maxLength: 20, type: 'text' },
            'Passport_details': { maxLength: 20, type: 'text' },
            'Date_birth': { type: 'date' },
            'Date_employment': { type: 'date' }
        },
        'service': {
            'Item_Name': { maxLength: 100, type: 'text' },
            'Item_Description': { maxLength: 500, type: 'text' },
            'Price': { min: 0, max: 999999.99, type: 'number', step: 0.01 }
        },
        'processed_customer_orders': {
            'Final_sum': { min: 0, max: 999999.99, type: 'number', step: 0.01 },
            'Date_Start': { type: 'date' },
            'Date_Ending': { type: 'date' }
        },
        'role': {
            'roll_name': { maxLength: 50, type: 'text' },
            'salary': { min: 0, max: 999999.99, type: 'number', step: 0.01 }
        }
    };

    // Функция для создания поля ввода с информацией об ограничениях
    function createInputWithConstraints(key, value, tableName) {
        const constraints = fieldConstraints[tableName]?.[key] || { type: 'text', maxLength: 255 };
        const container = document.createElement('div');
        container.className = 'modal-field';
        
        const label = document.createElement('label');
        label.textContent = key;
        container.appendChild(label);
        
        let input;
        if (constraints.type === 'select') {
            // Обработка выпадающих списков
            input = document.createElement('select');
            input.name = key;
            input.required = true;
            // Здесь можно добавить options если нужно
        } else {
            input = document.createElement('input');
            input.name = key;
            input.type = constraints.type;
            input.value = value || '';
            
            if (constraints.type === 'text' && constraints.maxLength) {
                input.maxLength = constraints.maxLength;
            }
            if (constraints.type === 'number') {
                if (constraints.min !== undefined) input.min = constraints.min;
                if (constraints.max !== undefined) input.max = constraints.max;
                if (constraints.step !== undefined) input.step = constraints.step;
            }
        }
        
        container.appendChild(input);
        
        const info = document.createElement('div');
        info.className = 'field-info';
        
        if (constraints.type === 'text' && constraints.maxLength) {
            
            // Добавляем счетчик только для текстовых полей с ограничением длины
            const counter = document.createElement('div');
            counter.className = 'char-counter';
            counter.id = `counter-${key}`;
            counter.textContent = `${value?.length || 0}/${constraints.maxLength}`;
            container.appendChild(counter);
            
            input.addEventListener('input', function() {
                const currentLength = this.value.length;
                counter.textContent = `${currentLength}/${constraints.maxLength}`;
                
                if (currentLength >= constraints.maxLength) {
                    counter.classList.add('limit-reached');
                } else {
                    counter.classList.remove('limit-reached');
                }
            });
            
            input.dispatchEvent(new Event('input'));
        } 
        else if (constraints.type === 'number') {
            if (constraints.min !== undefined && constraints.max !== undefined) {
                info.textContent = `Допустимый диапазон: ${constraints.min} — ${constraints.max}`;
            } else if (constraints.min !== undefined) {
                info.textContent = `Минимальное значение: ${constraints.min}`;
            } else if (constraints.max !== undefined) {
                info.textContent = `Максимальное значение: ${constraints.max}`;
            }
        }
        else if (constraints.type === 'date') {
            info.textContent = `Формат даты: ГГГГ-ММ-ДД`;
        }
        
        container.appendChild(info);
        
        return container;
    }

    function selectRow(row) {
      document.querySelectorAll('tr').forEach(r => r.style.backgroundColor = '');
      row.style.backgroundColor = '#ffe0e0';
      row.setAttribute('data-selected', 'true');
    }

    function getSelectedRowData() {
      const selected = document.querySelector('tr[data-selected="true"]');
      if (!selected) return null;
      
      const keys = Object.keys(tableData[0]);
      const data = {};
      
      keys.forEach((key, i) => {
        const cell = selected.children[i];
        if (key === 'ImageBase64' && cell.querySelector('img')) {
          // Для изображений берем src
          data[key] = cell.querySelector('img').src.split(',')[1];
        } else {
          // Для обычных ячеек - текстовое содержимое
          data[key] = cell.textContent;
        }
      });
      
      return data;
    }

    function openModal(mode) {
      const modal = document.getElementById('modal');
      const formFields = document.getElementById('formFields');
      const modalTitle = document.getElementById('modalTitle');
      formFields.innerHTML = '';

      let data = mode === 'edit' ? getSelectedRowData() : {};
      if (mode === 'edit' && !data) {
        return alert('Выберите строку для изменения.');
      }

      modalTitle.textContent = mode === 'edit' ? 'Изменить запись' : 'Добавить запись';

      // Обработка специальных случаев
      if (currentTable === 'service') {
  for (let key in tableData[0]) {
    if (key === 'ImageBase64') {
      formFields.innerHTML += `
        <div class="modal-field">
          <label>Фото</label>
          <input type="file" name="ImageBase64" accept="image/*" />
          ${data[key] ? `<img src="data:image/jpeg;base64,${data[key]}" style="max-width: 100px; margin-top: 10px;"/>` : ''}
        </div>
      `;
    } else if (!key.toLowerCase().includes('id')) {
      formFields.appendChild(createInputWithConstraints(key, data?.[key], currentTable));
    }
  }
}else if (currentTable === 'processed_customer_orders') {
        loadStatuses().then(statuses => {
          formFields.innerHTML = `
            <div class="modal-field">
              <label>Статус</label>
              <select name="ID_Status_Orders" required>
                ${statuses.map(status => 
                  `<option value="${status.ID_Status_Orders}" ${data.ID_Status_Orders == status.ID_Status_Orders ? 'selected' : ''}>
                    ${status.Name_Status}
                  </option>`
                ).join('')}
              </select>
            </div>
            <div class="modal-field">
              <label>Дата начала</label>
              <input type="date" name="Date_Start" value="${data.Date_Start || ''}" required />
            </div>
            <div class="modal-field">
              <label>Дата окончания</label>
              <input type="date" name="Date_Ending" value="${data.Date_Ending || ''}" />
            </div>
            <div class="modal-field">
              <label>Итоговая сумма</label>
              <input type="number" step="0.01" name="Final_sum" value="${data.Final_sum || ''}" required />
              <div class="char-counter">Числовое поле</div>
            </div>
          `;
          document.getElementById('recordId').value = data?.ID_Processed_customer_orders || '';
          modal.style.display = 'flex';
        });
        return;
      } else if (currentTable === 'staff') {
        const currentRoleId = data?.ID_Role || '';
        const roleOptions = rolesData.map(role =>
          `<option value="${role.ID_Role}" ${role.ID_Role == currentRoleId ? 'selected' : ''}>${role.roll_name}</option>`
        ).join('');

        formFields.innerHTML += `
          <div class="modal-field">
            <label>Роль</label>
            <select name="ID_Role" required>${roleOptions}</select>
            <div class="char-counter">Выпадающий список</div>
          </div>
        `;

        for (let key in tableData[0]) {
          if (['ID_Staff', 'ID_Role', 'roll_name'].includes(key)) continue;
        formFields.appendChild(createInputWithConstraints(key, data?.[key], currentTable));
      }
      } else {
        for (let key in tableData[0]) {
          if (key.toLowerCase().includes('id')) continue;
          
          // Для числовых полей и дат не показываем счетчик
          if (key === 'Final_sum' || key === 'Price' || key === 'salary' || 
              key === 'Date_Start' || key === 'Date_Ending' || key === 'Date_birth' || 
              key === 'Date_employment' || key === 'Order_Date') {
            formFields.innerHTML += `
              <div class="modal-field">
                <label>${key}</label>
                <input name="${key}" value="${data?.[key] || ''}" 
                  ${key.includes('Date') ? 'type="date"' : 'type="number" step="0.01"'} 
                  required />
                <div class="char-counter">${key.includes('Date') ? 'Дата' : 'Числовое поле'}</div>
              </div>
            `;
          } else {
        formFields.appendChild(createInputWithConstraints(key, data?.[key], currentTable));
      }
        }
      }

      document.getElementById('recordId').value = data?.[Object.keys(data)[0]] || '';
      modal.style.display = 'flex';
    }


    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    document.getElementById('modalForm').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      const data = {};
      const fileInput = form.querySelector('input[type="file"]');

      for (let input of form.querySelectorAll('input[name]:not([type="file"]), select[name]')) {
        data[input.name] = input.value;
      }

      if (fileInput && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const base64 = await fileToBase64(file);
        data.ImageBase64 = base64.split(',')[1];
      }

      const id = form.querySelector('#recordId').value;
      const method = id ? 'PUT' : 'POST';
      const url = `/api/${currentTable}${id ? '/' + id : ''}`;

      try {
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          alert('Запись успешно сохранена!');
          closeModal();
          loadTable(currentTable);
        } else {
          const error = await response.text();
          alert(`Ошибка: ${error}`);
        }
      } catch (error) {
        console.error('Ошибка при отправке:', error);
        alert('Ошибка при добавлении записи.');
      }
    });

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function deleteRecord() {
      const data = getSelectedRowData();
      if (!data) return alert('Выберите строку для удаления');
      const id = Object.values(data)[0];
      const confirmed = confirm('Удалить выбранную запись?');
      if (!confirmed) return;
      await fetch(`/api/${currentTable}/${id}`, { method: 'DELETE' });
      loadTable(currentTable);
    }

    loadTable('users');
  </script>
</body>
</html>